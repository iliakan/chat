{
  "name": "express-domain-middleware",
  "version": "0.1.0",
  "description": "wrap express request/response with node domains",
  "main": "index.js",
  "directories": {
    "test": "test"
  },
  "scripts": {
    "test": "npm install express && mocha"
  },
  "repository": {
    "type": "git",
    "url": "git://github.com/brianc/node-domain-middleware"
  },
  "keywords": [
    "domain",
    "express",
    "middleware"
  ],
  "author": {
    "name": "Brian M. Carlson"
  },
  "license": "MIT",
  "devDependencies": {
    "omf": "~0.3.0",
    "okay": "~0.2.0",
    "mocha": "~1.8.2",
    "express": "~3.2.4"
  },
  "readme": "# express-domain-middleware\n\n[![Build Status](https://travis-ci.org/brianc/node-domain-middleware.png?branch=master)](https://travis-ci.org/brianc/node-domain-middleware)\n\nHi! Are you using `process.uncaughtException` in your express apps to keep them running?\n\nOR...Do you just let your process crash on any unhandled exception and restart it?\n\nDo you find it hard to pass \"request.id\" to 8 nested database calls so you can keep a context of what request you're working on?\n\nHow do you associate log entries with a specific request?  Passing the request around everywhere again?\n\nDomains can help.\n\n## USE DOMAINS\n\nFirst, [read this](http://nodejs.org/api/domain.html)\n\nSecond, realize once you enable domains `process.domain` will give you the active domain.\n\nThird, use this middleware to bind each request/response pair to its own domain.\n\n```js\nexpress.use(require('express-domain-middleware'));\n```\n\n### express-domain-middleware api\n\n#### var domainMiddleware = require('express-domain-middleware');\n\n#### domainMiddleware = function(req, res, next) \n\nExports a function matching the signature of express middleware.  Binds incoming request & response from express to a new domain.  Assigns the domain a unique id by calling `domainMiddleware.id(req)`.\n\nIf the domain emits an error event, `domainMiddleware` will call `next(err)` with the error event from the domain.  This allows existing express specific error handling middleware to\nfunction as if the error was hanlded by your application code.  Allow me to demonstrate with an example:\n\n```js\n///old-school\napp.get('/error', function(req, res, next) {\n  db.query('SELECT happiness()', function(err, rows) {\n    if(err) return next(err);    \n    fs.readFile('alskdjflasd', function(err, contents) {\n      if(err) return next(err);\n      process.nextTick(function() {\n        throw new Error(\"congratulations, your node process crashed and the user request disconnected in a jarring way\");\n      });\n    });\n  })\n});\n```\n\n\nnow with less crashing...\n\n\n```js\n//with domain-middleware\napp.use(require('express-domain-middleware'));\napp.use(app.router);\napp.use(function errorHandler(err, req, res, next) {\n  console.log('error on request %d %s %s: %j', process.domain.id, req.method, req.url, err);\n  res.send(500, \"Something bad happened. :(\");\n  if(err.domain) {\n    //you should think about gracefully stopping & respawning your server\n    //since an unhandled error might put your application into an unknown state\n  }\n});\napp.get('/error', function(req, res, next) {\n  db.query('SELECT happiness()', process.domain.intercept(function(rows) {\n    fs.readFile('asldkfjasdf', process.domain.intercept(function(contents) {\n      process.nextTick(process.domain.intercept(function() {\n        throw new Error(\"The individual request will be passed to the express error handler, and your application will keep running.\");\n      }));\n    }));\n  }));\n});\n```\n\n\nI have to recommend using [okay](https://github.com/brianc/node-okay) to gracefully fallback in the absence of domains.  Plus..it's terse. Go, code golf!\n\n```js\nvar ok = require('okay');\napp.use(require('express-domain-middleware'));\napp.use(app.router);\napp.use(function errorHandler(err, req, res, next) {\n  console.log('error on request %d %s %s: %j', process.domain.id, req.method, req.url, err);\n  res.send(500, \"Something bad happened. :(\");\n});\napp.get('/error', function(req, res, next) {\n  db.query('SELECT happiness()', ok(next, function(rows) {\n    fs.readFile('asldkfjasdf', ok(next, function(contents) {\n      process.nextTick(ok(next, function() {\n        throw new Error(\"The individual request will be passed to the express error handler, and your application will keep running.\");\n      }));\n    }));\n  }));\n});\n```\n\n## license\nMIT\n",
  "readmeFilename": "README.md",
  "bugs": {
    "url": "https://github.com/brianc/node-domain-middleware/issues"
  },
  "_id": "express-domain-middleware@0.1.0",
  "dist": {
    "shasum": "36731b7c1901284fbf4fb5a62b0e7b0457d8e8c5"
  },
  "_from": "express-domain-middleware@",
  "_resolved": "https://registry.npmjs.org/express-domain-middleware/-/express-domain-middleware-0.1.0.tgz"
}
